name: dashboard

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3️⃣ Install dependencies
      - name: Install Python packages
        run: pip install requests plotly

      # 4️⃣ Generate dashboard
      - name: Generate Dashboard HTML
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import plotly.graph_objects as go
          import os
          import json

          # --- Configuration ---
          repo = os.environ['GITHUB_REPOSITORY']  # e.g., user/repo
          token = os.environ['GITHUB_TOKEN']
          max_runs = 10

          # --- Fetch workflow runs ---
          headers = {"Authorization": f"token {token}"}
          url = f"https://api.github.com/repos/{repo}/actions/runs?per_page={max_runs}"
          resp = requests.get(url, headers=headers)
          runs = resp.json().get("workflow_runs", [])

          # --- Prepare data ---
          run_numbers = [r["run_number"] for r in runs]
          conclusions = [r["conclusion"] or "in_progress" for r in runs]
          durations = [
              (r["run_attempts"][0]["run_duration_ms"]/60000 if r.get("run_attempts") else 0)
              for r in runs
          ]

          colors = ["green" if c=="success" else "red" if c=="failure" else "orange" for c in conclusions]

          # --- Build Plotly chart ---
          fig = go.Figure()
          fig.add_trace(go.Bar(
              x=run_numbers,
              y=durations,
              marker_color=colors,
              text=conclusions,
              textposition='auto'
          ))
          fig.update_layout(
              title=f"Recent Build Durations - {repo}",
              xaxis_title="Run Number",
              yaxis_title="Duration (minutes)"
          )

          # --- Export to dashboard/index.html ---
          os.makedirs("dashboard", exist_ok=True)
          fig.write_html("dashboard/index.html", include_plotlyjs="cdn")
          EOF

      # 5️⃣ Deploy to GitHub Pages (gh-pages branch)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dashboard
